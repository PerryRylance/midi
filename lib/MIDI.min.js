function MIDIStream(t){if(this.write=null,t){if(!(t instanceof ArrayBuffer))throw new Error("Input must be an instance of ArrayBuffer or omitted for write stream");this._dv=new DataView(t)}else this.write=[];this.position=0}function MIDIMetaEvent(t,e,r,n){this.type=t?t:null,this.text=n?n:null,this.unknownLength=null,this.unknownBytes=null,this.param1=e?e:0,this.param2=r?r:0}function MIDISysExEvent(t){this.unknownLength=0,this.unknownBytes=[],this.auth=t}function MIDIControlEvent(t,e,r,n){this.type=t?t:null,this.param1=e?e:0,this.param2=r?r:0,this.channel=n?n:0,this.delta=0}MIDIStream.prototype.readByte=function(){var t=this._dv.getUint8(this.position);return this.position++,t},MIDIStream.prototype.readShort=function(){var t=this._dv.getUint16(this.position);return this.position+=2,t},MIDIStream.prototype.readUint=function(){var t=this._dv.getUint32(this.position);return this.position+=4,t},MIDIStream.prototype.readVLV=function(){var t,e;if(128&(t=this.readByte())){t&=127;do t=(t<<7)+(127&(e=this.readByte()));while(128&e)}return t},MIDIStream.prototype.writeByte=function(t){this.write[this.position]=t,this.position++},MIDIStream.prototype.writeShort=function(t){this.write[this.position]=(65280&t)>>8,this.write[this.position+1]=255&t,this.position+=2},MIDIStream.prototype.writeUint=function(t){this.write[this.position]=(4278190080&t)>>24,this.write[this.position+1]=(16711680&t)>>16,this.write[this.position+2]=(65280&t)>>8,this.write[this.position+3]=255&t,this.position+=4},MIDIStream.prototype.writeVLV=function(t){for(var e=127&t;(t>>=7)>0;)e<<=8,e|=128,e+=127&t;for(;;){if(this.writeByte(e),!(128&e))break;e>>=8}},MIDIStream.prototype.toArrayBuffer=function(){if(!this.write)throw new Error("This is not a write stream");for(var t=new ArrayBuffer(this.write.length),e=new DataView(t),r=this.write.length,n=0;r>n;n++)e.setUint8(n,this.write[n]);return t},MIDIStream.prototype.toDataURL=function(){function t(t){for(var e="",r=new Uint8Array(t),n=r.byteLength,a=0;n>a;a++)e+=String.fromCharCode(r[a]);return window.btoa(e)}if(!this.write)throw new Error("This is not a write stream");var e=this.toArrayBuffer(),r=t(e);return"data:audio/midi;base64,"+r};var MIDIFile=function(){function t(){this.tracks=[],this.type=0,this.timeDivision=480}function e(t){var e=t.readUint();if(e!=n)throw new Error("Invalid MIDI header - MThd not found");var r,a=t.readUint();if(this.type=t.readShort(),r=t.readShort(),this.timeDivision=t.readShort(),a>6)for(var I=0;a-6>I;I++)t.readByte();return r}function r(t){this.tracks.length>1&&1!=this.type&&(console&&console.log("WARNING: MIDIFile has more than one track - forcing MIDI type 1"),this.type=1),t.writeUint(n),t.writeUint(6),t.writeShort(this.type),t.writeShort(this.tracks.length),t.writeShort(this.timeDivision)}var n=1297377380;return t.prototype.toString=function(){var t=new MIDIStream;this.writeBytes(t);for(var e="[MIDI File - Type "+this.type+", "+this.tracks.length+" tracks, "+this.timeDivision+" delta ticks per quarter note]\r\n",r=0;r<this.tracks.length;r++)e+=this.tracks[r].toString();return e},t.prototype.readBytes=function(t){this.tracks=[];for(var r=e.call(this,t),n=0;r>n;n++)this.tracks[n]=new MIDITrack,this.tracks[n].readBytes(t)},t.prototype.writeBytes=function(t){r.call(this,t);for(var e=0;e<this.tracks.length;e++)this.tracks[e].writeBytes(t)},t}(),MIDITrack=function(){function t(){this._writeSize,this.events=[],this.name=""}var e=1297379947;return t.prototype.readBytes=function(t){var r=t.readUint();if(r!=e)throw new Error("Invalid track - Expected MTrk");var n=t.readUint(),a=0,I=0,E=!1,i=[];for(i[0]=0;n>a;){I=t.position;try{event=MIDIEvent.read(t,i),this.events.push(event)}catch(o){throw new Error("Failed to read event at 0x"+I.toString(16)+": "+o)}event instanceof MIDIMetaEvent&&(event.type==MIDIMetaEvent.END_OF_TRACK?E=!0:event.type==MIDIMetaEvent.TRACK_NAME&&(this.name=event.text)),a+=t.position-I}if(!E)throw new Error("Expected end of track event");if(n>a)throw new Error("Read less bytes than track chunk size")},t.prototype.writeBytes=function(t){var r,n,a;t.writeUint(e),r=t.position,t.writeUint(0);for(var I=0;I<this.events.length;I++)this.events[I].type!=MIDIMetaEvent.END_OF_TRACK&&this.events[I].writeBytes(t);var E=new MIDIMetaEvent(MIDIMetaEvent.END_OF_TRACK);E.writeBytes(t),n=t.position,this._writeSize=a=n-r-4,t.position=r,t.writeUint(a),t.position=n},t.prototype.toString=function(){for(var t="[MIDI Track - "+this._writeSize+" bytes]\r\n",e=0;e<this.events.length;e++)t+=this.events[e].toString()+"\r\n";return t},t}(),MIDIEvent={TYPE_CONTROL:0,TYPE_SYSEX:240,TYPE_AUTHORIZATION_SYSEX:247,TYPE_META:255,read:function(t,e){var r,n,a=t.readVLV(),I=t.readByte();switch(I=255&I,r=240&I,I){case MIDIEvent.TYPE_META:n=new MIDIMetaEvent;break;case MIDIEvent.TYPE_SYSEX:case MIDIEvent.TYPE_AUTHORIZATION_SYSEX:n=new MIDISysExEvent(I==EVENT_AUTHORIZATION_SYSEX);break;default:n=new MIDIControlEvent}return n.delta=a,n.type=I,n.readBytes(t,e),n}};MIDIMetaEvent.prototype.setTempo=function(t){this.type=MIDIMetaEvent.SET_TEMPO,this.param1=Math.round(6e7/t)},MIDIMetaEvent.prototype.readBytes=function(t){var e,r;switch(this.type=t.readByte(),this.type){case MIDIMetaEvent.TEXT:case MIDIMetaEvent.COPYRIGHT:case MIDIMetaEvent.TRACK_NAME:case MIDIMetaEvent.INSTRUMENT_NAME:case MIDIMetaEvent.LYRIC:case MIDIMetaEvent.MARKER:case MIDIMetaEvent.CUE_POINT:for(r=t.readByte(),this.text="",e=0;r>e;e++)this.text+=String.fromCharCode(t.readByte());break;case MIDIMetaEvent.SET_TEMPO:r=t.readByte();var n,a,I;n=255&t.readByte(),a=255&t.readByte(),I=255&t.readByte(),this.param1=n<<16|a<<8|I;break;case MIDIMetaEvent.SMPTE_OFFSET:r=t.readByte(),_param1=t.readByte(),_param2=t.readUint();break;case MIDIMetaEvent.TIME_SIGNATURE:r=t.readByte(),this.param1=t.readShort(),this.param2=t.readShort();break;case MIDIMetaEvent.KEY_SIGNATURE:case MIDIMetaEvent.SEQUENCE_NUMBER:r=t.readByte(),this.param1=t.readByte(),this.param2=t.readByte();break;case MIDIMetaEvent.END_OF_TRACK:r=t.readByte();break;case MIDIMetaEvent.CHANNEL_PREFIX:case MIDIMetaEvent.PORT_PREFIX:r=t.readByte(),this.param1=t.readByte();break;case MIDIMetaEvent.SEQUENCER_SPECIFIC:for(r=this.unknownLength=t.readVLV(),this.unknownBytes=[],e=0;r>e;e++)this.unknownBytes[e]=t.readByte();break;default:throw new Error("Unknown meta event type 0x"+type.toString(16))}},MIDIMetaEvent.prototype.writeBytes=function(t){switch(t.writeVLV(this.delta),t.writeByte(MIDIEvent.TYPE_META),t.writeByte(this.type),this.type){case MIDIMetaEvent.TEXT:case MIDIMetaEvent.COPYRIGHT:case MIDIMetaEvent.TRACK_NAME:case MIDIMetaEvent.INSTRUMENT_NAME:case MIDIMetaEvent.LYRIC:case MIDIMetaEvent.MARKER:case MIDIMetaEvent.CUE_POINT:null==this.text&&(this.text=""),this.text.length>255&&(console&&console.log("WARNING: Trimming meta event text to 255 characters"),this.text=this.text.substr(0,255)),t.writeByte(Math.min(this.text.length,255));for(var e=0;e<this.text.length;e++)t.writeByte(this.text.charCodeAt(e));break;case MIDIMetaEvent.SEQUENCE_NUMBER:t.writeByte(2),t.writeByte(this.param1),t.writeByte(this.param2);break;case MIDIMetaEvent.END_OF_TRACK:t.writeByte(0);break;case MIDIMetaEvent.SET_TEMPO:t.writeByte(3),t.writeByte((16711680&this.param1)>>16),t.writeByte((65280&this.param1)>>8),t.writeByte(255&this.param1);break;case MIDIMetaEvent.SMPTE_OFFSET:t.writeByte(5),t.writeByte(this.param1),t.writeUint(this.param2);break;case MIDIMetaEvent.TIME_SIGNATURE:t.writeByte(4),t.writeShort(this.param1),t.writeShort(this.param2);break;case MIDIMetaEvent.KEY_SIGNATURE:t.writeByte(2),t.writeByte(this.param1),t.writeByte(this.param2);break;case MIDIMetaEvent.CHANNEL_PREFIX:case MIDIMetaEvent.PORT_PREFIX:t.writeByte(1),t.writeByte(this.param1);break;case MIDIMetaEvent.SEQUENCER_SPECIFIC:t.writeVLV(this.unknownLength);for(var e=0;e<this.unknownLength;e++)t.writeByte(this.unknownBytes[e]);break;default:throw new Error("Don't know how to write meta event type 0x"+this.type.toString(16))}},MIDIMetaEvent.prototype.toString=function(){var t="[MIDIMetaEvent type=";switch(this.type){case MIDIMetaEvent.SEQUENCE_NUMBER:t+="SEQUENCE_NUMBER";break;case MIDIMetaEvent.TEXT:t+="TEXT";break;case MIDIMetaEvent.COPYRIGHT:t+="COPYRIGHT";break;case MIDIMetaEvent.TRACK_NAME:t+="TRACK_NAME";break;case MIDIMetaEvent.INSTRUMENT_NAME:t+="INSTRUMENT_NAME";break;case MIDIMetaEvent.LYRIC:t+="LYRIC";break;case MIDIMetaEvent.MARKER:t+="MARKER";break;case MIDIMetaEvent.CUE_POINT:t+="CUE_POINT";break;case MIDIMetaEvent.CHANNEL_PREFIX:t+="CHANNEL_PREFIX";break;case MIDIMetaEvent.PORT_PREFIX:t+="PORT_PREFIX";break;case MIDIMetaEvent.END_OF_TRACK:t+="END_OF_TRACK";break;case MIDIMetaEvent.SET_TEMPO:t+="SET_TEMPO";break;case MIDIMetaEvent.SMPTE_OFFSET:t+="SMPTE_OFFSET";break;case MIDIMetaEvent.TIME_SIGNATURE:t+="TIME_SIGNATURE";break;case MIDIMetaEvent.KEY_SIGNATURE:t+="KEY_SIGNATURE";break;case MIDIMetaEvent.SEQUENCER_SPECIFIC:t+="SEQUENCER_SPECIFIC";break;default:t+="UNKNOWN"}return t+=" param1: 0x"+this.param1.toString(16)+", param2: 0x"+this.param2.toString(16),this.text&&(t+=" text='"+this.text+"'"),t+="]"},MIDIMetaEvent.SEQUENCE_NUMBER=0,MIDIMetaEvent.TEXT=1,MIDIMetaEvent.COPYRIGHT=2,MIDIMetaEvent.TRACK_NAME=3,MIDIMetaEvent.INSTRUMENT_NAME=4,MIDIMetaEvent.LYRIC=5,MIDIMetaEvent.MARKER=6,MIDIMetaEvent.CUE_POINT=7,MIDIMetaEvent.CHANNEL_PREFIX=32,MIDIMetaEvent.PORT_PREFIX=33,MIDIMetaEvent.END_OF_TRACK=47,MIDIMetaEvent.SET_TEMPO=81,MIDIMetaEvent.SMPTE_OFFSET=84,MIDIMetaEvent.TIME_SIGNATURE=88,MIDIMetaEvent.KEY_SIGNATURE=89,MIDIMetaEvent.SEQUENCER_SPECIFIC=127,MIDISysExEvent.prototype.toString=function(){return"[MIDISysExEvent length="+this.unknownLength+" authorization="+this.auth+"]"},MIDISysExEvent.prototype.readBytes=function(t){this.unknownLength=t.readVLV();for(var e=0;e<this.unknownLength;e++)this.unknownBytes[e]=t.readByte()},MIDISysExEvent.prototype.writeBytes=function(t){t.writeVLV(this.unknownLength);for(var e=0;e<this.unknownLength;e++)t.writeByte(this.unknownBytes[e])},MIDIControlEvent.prototype.toString=function(){var t="[MIDIControlEvent type=";switch(this.type){case MIDIControlEvent.NOTE_OFF:t+="NOTE_OFF";break;case MIDIControlEvent.NOTE_ON:t+="NOTE_ON";break;case MIDIControlEvent.AFTERTOUCH:t+="AFTERTOUCH";break;case MIDIControlEvent.CONTROLLER:t+="CONTROLLER";break;case MIDIControlEvent.PROGRAM_CHANGE:t+="PROGRAM_CHANGE";break;case MIDIControlEvent.CHANNEL_AFTERTOUCH:t+="CHANNEL_AFTERTOUCH";break;case MIDIControlEvent.PITCH_BEND:t+="PITCH_BEND";break;default:t+="UNKNOWN"}return t+=" param1="+this.param1+" param2="+this.param2+" channel="+this.channel+"]"},MIDIControlEvent.prototype.readBytes=function(t,e){var r,n=!1,a=0,I=this.type;if(r=this.type=240&I,this.channel=15&I,this.channel>15)throw new Error("Invalid channel number "+this.channel);if(128>r){if(2!=e.length)throw new Error("Invalid running status");n=!0,this.type=r=e[0],this.channel=e[1]}else e[0]=r,e[1]=this.channel;switch(r){case MIDIControlEvent.NOTE_ON:case MIDIControlEvent.NOTE_OFF:case MIDIControlEvent.AFTERTOUCH:case MIDIControlEvent.CONTROLLER:case MIDIControlEvent.PITCH_BEND:a=2;break;case MIDIControlEvent.PROGRAM_CHANGE:case MIDIControlEvent.CHANNEL_AFTERTOUCH:a=1;break;default:throw new Error("Unknown control event type 0x"+r.toString(16))}a>0&&(this.param1=n?I:t.readByte()),a>1&&(this.param2=t.readByte())},MIDIControlEvent.prototype.writeBytes=function(t){switch(t.writeVLV(this.delta),t.writeByte(this.type|this.channel),this.type){case MIDIControlEvent.NOTE_ON:case MIDIControlEvent.NOTE_OFF:case MIDIControlEvent.AFTERTOUCH:case MIDIControlEvent.CONTROLLER:case MIDIControlEvent.PITCH_BEND:t.writeByte(this.param1),t.writeByte(this.param2);break;case MIDIControlEvent.PROGRAM_CHANGE:case MIDIControlEvent.CHANNEL_AFTERTOUCH:t.writeByte(this.param1);break;default:throw new Error("Don't know how to write control event type 0x"+this.type.toString(16))}},MIDIControlEvent.prototype.pitch=function(){return arguments.length>0?void(this.param1=arguments[0]):this.param1},MIDIControlEvent.prototype.velocity=function(){return arguments.length>0?void(this.param2=arguments[0]):this.param2},MIDIControlEvent.NOTE_OFF=128,MIDIControlEvent.NOTE_ON=144,MIDIControlEvent.AFTERTOUCH=160,MIDIControlEvent.CONTROLLER=176,MIDIControlEvent.PROGRAM_CHANGE=192,MIDIControlEvent.CHANNEL_AFTERTOUCH=208,MIDIControlEvent.PITCH_BEND=224;var MIDIInstrument=function(){var t={ACOUSTIC_GRAND_PIANO:0,BRIGHT_ACOUSTIC_PIANO:1,ELECTRIC_GRAND_PIANO:2,HONKY_TONK_PIANO:3,ELECTRIC_PIANO_1:4,ELECTRIC_PIANO_2:5,HARPSICHORD:6,CLAVINET:7,CELESTA:8,GLOCKENSPIEL:9,MUSIC_BOX:10,VIBRAPHONE:11,MARIMBA:12,XYLOPHONE:13,TUBULAR_BELLS:14,DULCIMER:15,DRAWBAR_ORGAN:16,PERCUSSIVE_ORGAN:17,ROCK_ORGAN:18,CHURCH_ORGAN:19,REED_ORGAN:20,ACCORDION:21,HARMONICA:22,TANGO_ACCORDION:23,ACOUSTIC_GUITAR_NYLON:24,ACOUSTIC_GUITAR_STEEL:25,ELECTRIC_GUITAR_JAZZ:26,ELECTRIC_GUITAR_CLEAN:27,ELECTRIC_GUITAR_MUTED:28,OVERDRIVEN_GUITAR:29,DISTORTION_GUITAR:30,GUITAR_HARMONICS:31,ACOUSTIC_BASS:32,ELECTRIC_BASS_FINGER:33,ELECTRIC_BASS_PICK:34,FRETLESS_BASS:35,SLAP_BASS_1:36,SLAP_BASS_2:37,SYNTH_BASS_1:38,SYNTH_BASS_2:39,VIOLIN:40,VIOLA:41,CELLO:42,CONTRABASS:43,TREMOLO_STRINGS:44,PIZZICATO_STRINGS:45,ORCHESTRAL_HARP:46,TIMPANI:47,STRING_ENSEMBLE_1:48,STRING_ENSEMBLE_2:49,SYNTH_STRINGS_1:50,SYNTH_STRINGS_2:51,CHOIR_AAHS:52,VOICE_OOHS:53,SYNTH_VOICE:54,ORCHESTRA_HIT:55,TRUMPET:56,TROMBONE:57,TUBA:58,MUTED_TRUMPET:59,FRENCH_HORN:60,BRASS_SECTION:61,SYNTH_BRASS_1:62,SYNTH_BRASS_2:63,SOPRANO_SAX:64,ALTO_SAX:65,TENOR_SAX:66,BARITONE_SAX:67,OBOE:68,ENGLISH_HORN:69,BASSOON:70,CLARINET:71,PICCOLO:72,FLUTE:73,RECORDER:74,PAN_FLUTE:75,BLOWN_BOTTLE:76,SHAKUHACHI:77,WHISTLE:78,OCARINA:79,LEAD_1_SQUARE:80,LEAD_2_SAWTOOTH:81,LEAD_3_CALLIOPE:82,LEAD_4_CHIFF:83,LEAD_5_CHARANG:84,LEAD_6_VOICE:85,LEAD_7_FIFTHS:86,LEAD_8_BASS_AND_LEAD:87,PAD_1_NEW_AGE:88,PAD_2_WARM:89,PAD_3_POLYSYNTH:90,PAD_4_CHOIR:91,PAD_5_BOWED:92,PAD_6_METALLIC:93,PAD_7_HALO:94,PAD_8_SWEEP:95,FX_1_RAIN:96,FX_2_SOUNDTRACK:97,FX_3_CRYSTAL:98,FX_4_ATMOSPHERE:99,FX_5_BRIGHTNESS:100,FX_6_GOBLINS:101,FX_7_ECHOES:102,FX_8_SCI_FI:103,SITAR:104,BANJO:105,SHAMISEN:106,KOTO:107,KALIMBA:108,BAG_PIPE:109,FIDDLE:110,SHANAI:111,TINKLE_BELL:112,AGOGO:113,STEEL_DRUMS:114,WOODBLOCK:115,TAIKO_DRUM:116,MELODIC_TOM:117,SYNTH_DRUM:118,REVERSE_CYMBAL:119,GUITAR_FRET_NOISE:120,BREATH_NOISE:121,SEASHORE:122,BIRD_TWEET:123,TELEPHONE_RING:124,HELICOPTER:125,APPLAUSE:126,GUNSHOT:127},e=0;for(var r in t)t[e]=r,e++;return t}();